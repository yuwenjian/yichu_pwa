# 衣物穿搭频率记录功能

> 实现日期: 2026-01-27

## 功能概述

为单个衣物添加穿搭频率记录功能，用户可以记录每次穿着，系统自动统计穿搭次数和最后穿搭时间。

## 功能特性

### 1. 数据记录
- **穿搭次数统计**：每次点击"记录穿搭"按钮，`use_count` 自动 +1
- **最后穿搭时间**：记录最近一次穿搭的时间戳 `last_used_at`
- **实时更新**：使用 React Query 自动更新缓存，无需手动刷新

### 2. 用户界面
- **记录按钮**：衣物详情页顶部添加"记录穿搭"主按钮
- **统计展示**：显示穿搭次数和最后穿搭时间
- **操作反馈**：点击后显示成功提示 Toast
- **加载状态**：按钮支持 loading 状态，防止重复提交

### 3. 数据同步
- **自动缓存更新**：记录后自动刷新当前衣物详情
- **列表同步**：同时刷新衣物列表缓存，保持数据一致性

## 技术实现

### 1. 数据库字段（已存在）
```sql
-- clothings 表
use_count INTEGER DEFAULT 0,           -- 使用次数
last_used_at TIMESTAMP,                -- 最后使用时间
```

### 2. React Query Hooks

新增了两个 Hook 在 `lib/hooks/useClothingsQuery.ts`：

#### `useClothing(clothingId: string)`
- 获取单个衣物详情
- 支持自动缓存和重新验证
- 返回 `{ data, isLoading, refetch }`

#### `useIncrementClothingUseCount()`
- 增加衣物使用次数
- 自动更新 `use_count` 和 `last_used_at`
- 成功后自动刷新相关缓存
- 返回 mutation 对象

### 3. 使用示例

```tsx
import { useClothing, useIncrementClothingUseCount } from '@/lib/hooks/useClothingsQuery'

// 在组件中使用
const { data: clothing, isLoading, refetch } = useClothing(clothingId)
const incrementUseCountMutation = useIncrementClothingUseCount()

// 记录穿搭
const handleRecordWear = async () => {
  try {
    await incrementUseCountMutation.mutateAsync(clothingId)
    toast.success('已记录本次穿搭')
  } catch (error) {
    toast.error('操作失败，请重试')
  }
}
```

## 用户体验

### 界面变化

**衣物详情页更新：**

1. **顶部按钮区域**
   - 新增"记录穿搭"主按钮（蓝色高亮）
   - 支持 loading 状态动画
   - 位于"编辑"和"删除"按钮左侧

2. **基本信息卡片**
   - 标题下方显示穿搭统计
   - 格式：`穿搭 X 次` 和 `最近穿搭: YYYY/MM/DD`
   - 使用点状装饰符，保持 Editorial 风格

3. **使用提示卡片**
   - 浅色背景高亮显示
   - 说明如何使用记录功能
   - 提示数据可在统计页面查看

### 操作流程

```
用户进入衣物详情页
      ↓
点击"记录穿搭"按钮
      ↓
显示 loading 状态
      ↓
后台更新数据（use_count +1, last_used_at = now）
      ↓
自动刷新页面数据
      ↓
显示成功提示 "已记录本次穿搭"
      ↓
用户可看到更新后的统计数据
```

## 数据统计

### 当前已实现
- ✅ 单个衣物的穿搭次数
- ✅ 单个衣物的最后穿搭时间
- ✅ 实时数据更新和缓存同步

### 后续可扩展

#### 1. 统计页面增强
- **最常穿衣物 Top 10**：按 `use_count` 排序
- **穿搭频率分析**：每周/每月穿搭次数趋势图
- **闲置衣物提醒**：超过 X 天未穿的衣物列表
- **穿搭日历**：按日期展示每天穿过的衣物

#### 2. 高级功能
- **穿搭记录详情**：记录每次穿搭的场合、天气等信息
- **衣物利用率**：计算 `使用次数 / 拥有天数`
- **搭配关联**：记录衣物通常与哪些衣物一起搭配
- **智能推荐**：基于穿搭频率推荐高频/低频衣物

#### 3. 数据可视化
- 穿搭频率分布图（柱状图）
- 季节穿搭趋势（折线图）
- 品牌使用频率对比（饼图）
- 价格与使用次数关系（散点图）

#### 4. 社交功能（可选）
- 分享今日穿搭
- 查看穿搭历史
- 穿搭打卡挑战

## 数据库查询示例

### 获取最常穿的衣物
```sql
SELECT 
  id, name, image_url, use_count, last_used_at
FROM clothings
WHERE wardrobe_id = $1
ORDER BY use_count DESC
LIMIT 10;
```

### 获取闲置衣物（30天未穿）
```sql
SELECT 
  id, name, image_url, 
  EXTRACT(DAY FROM NOW() - last_used_at) as days_since_last_wear
FROM clothings
WHERE wardrobe_id = $1
  AND (last_used_at IS NULL OR last_used_at < NOW() - INTERVAL '30 days')
ORDER BY last_used_at ASC NULLS FIRST;
```

### 统计穿搭总次数
```sql
SELECT 
  SUM(use_count) as total_wear_count,
  COUNT(*) as total_items,
  AVG(use_count) as avg_wear_per_item
FROM clothings
WHERE wardrobe_id = $1;
```

## 测试清单

- [x] 点击"记录穿搭"按钮，`use_count` 正确增加
- [x] 点击"记录穿搭"按钮，`last_used_at` 正确更新
- [x] 成功后显示 Toast 提示
- [x] 页面数据自动刷新
- [x] Loading 状态正确显示
- [x] 错误处理正常工作
- [ ] 多次快速点击不会导致重复提交
- [ ] 统计数据在统计页面正确显示

## 相关文件

### 新增/修改的文件
- `lib/hooks/useClothingsQuery.ts` - 添加 `useClothing` 和 `useIncrementClothingUseCount`
- `app/dashboard/wardrobes/[id]/clothings/[clothingId]/page.tsx` - 更新衣物详情页

### 相关功能参考
- `lib/hooks/useOutfitsQuery.ts` - 搭配使用次数记录（参考实现）
- `app/dashboard/outfits/[id]/page.tsx` - 搭配详情页（参考 UI）

## 后续计划

### Phase 1：统计页面集成（建议优先实现）
1. 在统计页面添加"穿搭分析"模块
2. 显示最常穿/最少穿衣物
3. 显示闲置衣物提醒

### Phase 2：数据可视化
1. 使用 Recharts 绘制穿搭趋势图
2. 添加筛选条件（按分类、时间范围等）

### Phase 3：高级功能
1. 穿搭日历视图
2. 穿搭记录详情（场合、天气等）
3. 智能推荐功能

---

**文档版本**: v1.0  
**创建日期**: 2026-01-27  
**作者**: AI Assistant
