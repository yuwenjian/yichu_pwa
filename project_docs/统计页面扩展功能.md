# 统计页面扩展功能

> 实现日期: 2026-01-27

## 功能概述

大幅扩展统计页面功能，添加多种数据可视化图表和高级数据分析功能，帮助用户深入了解衣橱使用情况。

## 新增功能列表

### 1. 最常穿衣物 Top 10 ⭐
- **功能描述**：展示使用次数最多的前10件衣物
- **展示方式**：卡片网格布局，显示图片和穿搭次数
- **交互**：点击可跳转到衣物详情页
- **数据来源**：按 `use_count` 降序排序

### 2. 闲置衣物提醒 ⭐
- **功能描述**：提醒适合当前季节但超过30天未穿的衣物
- **智能判断**：
  - 自动识别当前季节（春/夏/秋/冬）
  - 只显示包含当前季节标签的衣物
  - 统计距离上次穿搭的天数
- **视觉提示**：黄色警告边框和背景
- **显示内容**：
  - 从未穿过显示"从未穿"
  - 否则显示"X天"
- **最多显示**：前10件闲置衣物

### 3. 穿搭频率趋势图 ⭐
- **图表类型**：折线图（LineChart）
- **时间范围**：最近30天
- **数据维度**：每天的穿搭记录次数
- **技术实现**：使用 Recharts
- **特点**：
  - 包含0值的日期（完整30天数据）
  - 响应式设计
  - 悬停显示详细信息

### 4. 分类分布饼图
- **图表类型**：饼图（PieChart）
- **展示内容**：各分类衣物数量占比
- **显示方式**：
  - 标签显示分类名称和百分比
  - 使用不同颜色区分
  - 图例说明

### 5. 品牌使用频率分析
- **图表类型**：柱状图（BarChart）
- **数据维度**：
  - 品牌拥有的衣物数量
  - 品牌衣物的总穿搭次数
- **排序规则**：按总穿搭次数降序
- **最多显示**：Top 10 品牌

### 6. 价格与穿搭次数关系
- **图表类型**：散点图（ScatterChart）
- **分析目的**：了解价格与使用频率的关联
- **X轴**：衣物价格（元）
- **Y轴**：穿搭次数
- **用途**：
  - 发现高性价比衣物（低价高频）
  - 发现低利用率衣物（高价低频）
  - 优化购买决策

### 7. 衣物利用率
- **计算公式**：穿过的衣物数 / 总衣物数 × 100%
- **显示位置**：概览卡片第5张
- **评价标准**：
  - ≥70%：利用率很高
  - 50%-70%：利用率还不错
  - <50%：利用率偏低

### 8. 数据洞察卡片
- **功能描述**：提供智能化的数据分析建议
- **包含内容**：
  - 衣物利用率评价
  - 平均单价分析
  - 个性化建议

## 技术实现

### 扩展的统计接口

```typescript
interface Statistics {
  // 原有字段
  totalClothings: number
  totalOutfits: number
  totalValue: number
  avgPrice: number
  byCategory: Array<{ categoryName: string; count: number }>
  byStatus: Record<string, number>
  bySeason: Record<string, number>
  
  // 新增字段
  topClothings: TopClothing[]           // 最常穿衣物
  idleClothings: IdleClothing[]         // 闲置衣物
  wearTrends: WearTrend[]               // 穿搭趋势
  brandStats: BrandStats[]              // 品牌统计
  priceUsageData: PriceUsageData[]      // 价格使用数据
  utilizationRate: number               // 利用率
}
```

### 新增图表组件

#### 1. WearTrendChart（穿搭趋势图）
- **路径**：`components/charts/WearTrendChart.tsx`
- **依赖**：Recharts LineChart
- **特性**：
  - 自动格式化日期显示
  - 响应式容器
  - 自定义样式（使用 CSS 变量）

#### 2. BrandChart（品牌统计图）
- **路径**：`components/charts/BrandChart.tsx`
- **依赖**：Recharts BarChart
- **特性**：
  - 双柱状图（数量 + 穿搭次数）
  - 图例说明
  - 圆角柱状

#### 3. PriceUsageChart（价格使用关系图）
- **路径**：`components/charts/PriceUsageChart.tsx`
- **依赖**：Recharts ScatterChart
- **特性**：
  - 散点图展示
  - 悬停显示详细信息
  - 动态数据点大小

#### 4. CategoryPieChart（分类饼图）
- **路径**：`components/charts/CategoryPieChart.tsx`
- **依赖**：Recharts PieChart
- **特性**：
  - 标签显示百分比
  - 多色配色方案
  - 图例展示

### 数据查询优化

#### 季节判断逻辑
```typescript
const getCurrentSeason = () => {
  const month = new Date().getMonth() + 1
  if (month >= 3 && month <= 5) return '春'
  if (month >= 6 && month <= 8) return '夏'
  if (month >= 9 && month <= 11) return '秋'
  return '冬'
}
```

#### 闲置衣物筛选
```typescript
const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000)
const isIdle = !c.last_used_at || new Date(c.last_used_at) < thirtyDaysAgo
const isCurrentSeason = c.seasons?.includes(currentSeason)
```

#### 趋势数据生成
- 获取最近30天所有穿搭记录
- 按日期分组统计
- 填充缺失日期（值为0）

## 界面布局

### 统计页面结构

```
┌─ 页面标题和衣橱选择器 ──────────────────────┐
│ ANALYTICS                                   │
│ 数据统计                    [选择衣橱 ▼]     │
└─────────────────────────────────────────────┘

┌─ 概览卡片（5个）────────────────────────────┐
│ [总衣物数] [总搭配数] [总价值] [平均价格] [利用率] │
└─────────────────────────────────────────────┘

┌─ 按分类统计 ────────────────────────────────┐
│ 上衣............................ 15 件      │
│ 裤装............................ 10 件      │
└─────────────────────────────────────────────┘

┌─ 按状态 / 按季节（2列）─────────────────────┐
│ [状态统计]          [季节统计]              │
└─────────────────────────────────────────────┘

┌─ 最常穿衣物 Top 10 ─────────────────────────┐
│ [图1] [图2] [图3] [图4] [图5]               │
│  5次   4次   3次   3次   2次               │
└─────────────────────────────────────────────┘

┌─ 闲置衣物提醒 ⚠️ ───────────────────────────┐
│ 这些适合当前季节的衣物已超过30天未穿         │
│ [图1] [图2] [图3] [图4] [图5]               │
│ 45天  60天  从未穿 35天  40天               │
└─────────────────────────────────────────────┘

┌─ 穿搭频率趋势（折线图）─────────────────────┐
│         ╱╲                                  │
│      ╱╲╱  ╲  ╱╲                            │
│   ╱╲╱      ╲╱  ╲                           │
│ ╱╲                                         │
│ ────────────────────────────────           │
└─────────────────────────────────────────────┘

┌─ 分类分布（饼图）/ 品牌频率（柱状图）─────────┐
│ [饼图]              [柱状图]                │
└─────────────────────────────────────────────┘

┌─ 价格与穿搭次数关系（散点图）───────────────┐
│   •       •                                │
│      •  •     •                            │
│   •    •                                   │
└─────────────────────────────────────────────┘

┌─ 数据洞察 ──────────────────────────────────┐
│ [利用率评价]     [平均单价分析]             │
└─────────────────────────────────────────────┘
```

## 用户价值

### 1. 洞察穿搭习惯
- 了解哪些衣物最受欢迎
- 发现被忽视的闲置衣物
- 追踪穿搭频率变化

### 2. 优化购买决策
- 分析价格与使用频率关系
- 识别高性价比品牌
- 避免冲动购买

### 3. 提升衣橱利用率
- 主动提醒闲置衣物
- 鼓励多样化搭配
- 季节性穿搭建议

### 4. 数据驱动管理
- 量化衣橱价值
- 可视化数据展示
- 个性化建议

## 性能优化

### 数据查询
- 单次查询获取所有衣物数据
- 前端计算统计结果
- React Query 缓存机制

### 图表渲染
- Recharts 按需加载
- 响应式容器自动调整
- 空数据友好提示

### 用户体验
- 下拉刷新支持
- Loading 状态显示
- 平滑动画过渡

## 后续扩展计划

### Phase 1：穿搭日历视图
- 日历形式展示每天穿搭记录
- 点击日期查看当日搭配
- 支持添加穿搭笔记

### Phase 2：搭配关联分析
- 分析哪些衣物经常一起穿
- 推荐搭配组合
- 发现穿搭模式

### Phase 3：对比分析
- 不同衣橱对比
- 月度/年度趋势对比
- 分类使用频率对比

### Phase 4：导出报告
- 生成 PDF 统计报告
- 支持分享到社交平台
- 数据导出（Excel/CSV）

### Phase 5：AI 建议
- 基于穿搭习惯的智能推荐
- 购买建议
- 整理建议

## 技术依赖

### NPM 包
- `recharts`: ^2.10.3（图表库）
- `@tanstack/react-query`: ^5.17.0（数据查询）
- `@supabase/supabase-js`: ^2.39.0（数据库）

### 组件依赖
- Card、Button、PullToRefresh（UI 组件）
- 各种 Chart 组件

## 测试建议

### 功能测试
- [ ] 切换不同衣橱，数据正确更新
- [ ] 各种图表正确渲染
- [ ] 空数据状态友好显示
- [ ] 点击衣物跳转到详情页
- [ ] 下拉刷新正常工作

### 数据测试
- [ ] 最常穿衣物排序正确
- [ ] 闲置衣物季节判断准确
- [ ] 利用率计算正确
- [ ] 趋势图日期范围正确（30天）
- [ ] 品牌统计数据准确

### 性能测试
- [ ] 大量数据（100+衣物）加载性能
- [ ] 图表渲染流畅度
- [ ] 移动端响应式表现

### 边界测试
- [ ] 没有衣物时的显示
- [ ] 所有衣物都未穿过
- [ ] 单个品牌的情况
- [ ] 价格数据缺失

## 已知问题

1. **图片加载**：ESLint 警告使用 `<img>` 而非 Next.js `<Image>`
   - 原因：图片来自腾讯云 COS
   - 影响：可忽略，不影响功能

2. **趋势数据**：仅统计 `last_used_at`，可能不够精确
   - 改进方向：创建穿搭记录表记录每次穿搭

3. **季节判断**：硬编码月份区间
   - 改进方向：根据地理位置动态判断

## 相关文件

### 新增文件
- `lib/hooks/useStatisticsQuery.ts` - 扩展统计查询
- `components/charts/WearTrendChart.tsx` - 趋势图
- `components/charts/BrandChart.tsx` - 品牌图
- `components/charts/PriceUsageChart.tsx` - 价格散点图
- `components/charts/CategoryPieChart.tsx` - 分类饼图

### 修改文件
- `app/dashboard/statistics/page.tsx` - 统计页面主文件

---

**文档版本**: v1.0  
**创建日期**: 2026-01-27  
**作者**: AI Assistant
