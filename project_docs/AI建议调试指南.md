# AI 建议功能调试指南

## 🎯 已修改内容

### 1. 建议数量：3 条 → 8 条 ✅
- ✅ Prompt 模板更新
- ✅ 验证逻辑更新
- ✅ 前端显示自动适配

### 2. 数据查询调试 ✅
- ✅ 添加详细的调试日志
- ✅ 验证数据库查询结果
- ✅ 验证传递给 AI 的数据

## 📊 调试步骤

### Step 1: 清除缓存
打开浏览器开发者工具（F12），执行以下操作：

1. **清除 localStorage**
   ```javascript
   // 在 Console 中执行
   localStorage.clear()
   ```

2. **刷新页面**
   ```
   Ctrl+Shift+R (Windows)
   Cmd+Shift+R (Mac)
   ```

### Step 2: 查看日志
点击"开始扫描"按钮后，在 Console 中会看到详细的日志：

#### 📋 日志输出示例

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔍 开始准备 AI 分析数据
   wardrobeId: 1aed0e78-d6d0-488c-9e2e-ba21a78a787f
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📊 AI 建议数据查询结果:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🏷️  衣橱信息:
   - ID: 1aed0e78-d6d0-488c-9e2e-ba21a78a787f
   - 名称: 我的衣橱

👔 衣物查询:
   - 查询条件: wardrobe_id = 1aed0e78-d6d0-488c-9e2e-ba21a78a787f
   - 查询结果数量: 3
   - 是否有错误: NO
   - 第一件衣物示例:
     * ID: xxx
     * 名称: 白色T恤
     * 分类: { name: "上装" }
     * wardrobe_id: (字段未返回)

🎯 搭配查询:
   - 查询结果数量: 0
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ 准备发送给 DeepSeek 的数据:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📊 衣橱统计:
   - 衣物总数: 3
   - 搭配总数: 0
   - 总价值: ¥ 297.00
   - 平均价格: ¥ 99.00
   - 利用率: 33.3 %

🌍 上下文信息:
   - 当前季节: winter
   - 即将到来: spring
   - 最近购买: 3 件
   - 购买频率: medium

👤 用户偏好:
   - 风格偏好: 休闲, 简约
   - 喜欢的颜色: 白色, 黑色
   - 喜欢的品牌: Uniqlo
   - 预算水平: low
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### Step 3: 分析日志

#### ✅ 如果看到这些信息，说明数据正常：
```
👔 衣物查询:
   - 查询结果数量: 3          ← 显示正确的衣物数量
   - 是否有错误: NO            ← 没有错误

📊 衣橱统计:
   - 衣物总数: 3              ← 与查询结果一致
```

#### ❌ 如果看到这些信息，说明有问题：
```
👔 衣物查询:
   - 查询结果数量: 0          ← 没有查询到衣物！
   - 是否有错误: NO
   ⚠️  没有查询到任何衣物！
   请检查：
   1. wardrobeId 是否正确
   2. 数据库中是否有该衣橱的衣物
   3. clothings 表的 wardrobe_id 字段是否正确
```

## 🔍 问题排查

### 问题 1: 衣物数量为 0

#### 可能原因 A：wardrobeId 不正确
**检查方法：**
1. 查看日志中的 `wardrobeId`
2. 访问数据库，检查 `clothings` 表
3. 确认 `wardrobe_id` 字段是否匹配

**SQL 查询：**
```sql
SELECT id, name, wardrobe_id 
FROM clothings 
WHERE wardrobe_id = '你的衣橱ID';
```

#### 可能原因 B：数据库权限问题
**检查方法：**
1. 查看日志中的 `是否有错误` 字段
2. 如果有错误，查看错误详情
3. 可能是 Supabase 的 RLS (Row Level Security) 限制

**解决方案：**
```sql
-- 检查 RLS 策略
SELECT * FROM clothings; -- 使用 service_role_key 查询
```

#### 可能原因 C：字段名称不匹配
**检查方法：**
查看数据库表结构，确认字段名是 `wardrobe_id` 还是 `wardrobeId`

### 问题 2: AI 分析结果说衣物为 0

如果日志显示 `衣物总数: 3`，但 AI 分析说衣物为 0，说明：

1. **数据传递正确**，但 AI 理解错误
2. **Prompt 需要优化**

**解决方案：**
查看发送给 DeepSeek 的完整数据：

```javascript
// 在 deepseek-client.ts 中添加日志
console.log('发送给 DeepSeek 的 Prompt:', prompt)
```

## 📝 测试清单

### 基础功能测试
- [ ] 清除缓存
- [ ] 刷新页面
- [ ] 点击"开始扫描"
- [ ] 查看 Console 日志
- [ ] 确认衣物数量正确
- [ ] 等待 AI 分析完成
- [ ] 查看 8 条建议
- [ ] 确认建议内容基于真实数据

### 数据验证测试
- [ ] 衣物数量与数据库一致
- [ ] 衣橱统计数据正确
- [ ] 用户偏好推断合理
- [ ] 季节信息正确
- [ ] 购买频率计算准确

### 建议质量测试
- [ ] 返回 8 条建议
- [ ] 建议基于真实数据
- [ ] 提到具体的衣物数量
- [ ] 季节分析准确
- [ ] 购买习惯分析合理
- [ ] 风格偏好匹配

## 🚨 常见错误及解决方案

### 错误 1: TypeError: Cannot read property 'length' of undefined

**原因：** `clothings` 未正确初始化

**解决方案：**
```typescript
const clothings = clothingsResult.data || []  // 确保始终是数组
```

### 错误 2: 401 Unauthorized

**原因：** API Key 或数据库权限问题

**解决方案：**
1. 检查 `.env.local` 中的 `SUPABASE_SERVICE_ROLE_KEY`
2. 确认 Supabase 数据库权限配置

### 错误 3: 衣物查询返回空数组

**原因：** RLS 策略限制

**解决方案：**
```typescript
// 在 API Route 中使用 service_role_key
const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!  // 使用 service role
)
```

## 📞 如何报告问题

如果问题仍未解决，请提供以下信息：

### 必需信息
1. **完整的 Console 日志**（从"开始准备 AI 分析数据"到最后）
2. **wardrobeId** 的值
3. **数据库查询结果**：
   ```sql
   SELECT COUNT(*) FROM clothings WHERE wardrobe_id = '你的ID';
   ```
4. **AI 分析返回的内容**（建议截图）

### 有帮助的信息
- 浏览器类型和版本
- 是否清除了缓存
- 问题重现步骤
- 错误信息截图

## 🎯 预期结果

### 正常情况下的输出

#### 1. 数据查询日志
```
📊 AI 建议数据查询结果:
👔 衣物查询:
   - 查询结果数量: 3         ✅ 正确
   - 是否有错误: NO           ✅ 无错误
   - 第一件衣物示例: {...}    ✅ 有数据
```

#### 2. 数据准备日志
```
✅ 准备发送给 DeepSeek 的数据:
📊 衣橱统计:
   - 衣物总数: 3             ✅ 与查询一致
```

#### 3. AI 分析结果
```
✅ 使用 DeepSeek AI 建议
AI 总结: 您的衣橱有3件衣物...  ✅ 提到正确数量
```

#### 4. 页面显示
- ✅ 显示 8 条建议
- ✅ 建议内容提到具体数量
- ✅ 建议基于真实数据

---

**创建时间**: 2026-01-28  
**版本**: v1.2
